<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Greenback Shopper - Web</title>
    <style>
        :root {
            --bg: #071012;
            --panel: #0b1416;
            --neon: #00ff6a;
            --muted: #9aa6a6;
        }
        
        * { box-sizing: border-box; }
        body {
            font-family: Inter, Segoe UI, Arial, sans-serif;
            background: linear-gradient(180deg, #041014 0%, #071215 100%);
            color: #e6fff2;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: var(--panel);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,255,106,0.1);
        }
        
        .auth-container {
            text-align: center;
        }
        
        .app-title {
            font-size: 24px;
            margin-bottom: 30px;
            color: var(--neon);
        }
        
        .auth-input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background: rgba(0,255,106,0.05);
            border: 1px solid rgba(0,255,106,0.2);
            border-radius: 8px;
            color: #e6fff2;
            font-size: 16px;
        }
        
        .auth-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(90deg, var(--neon), #00cc55);
            border: none;
            border-radius: 8px;
            color: var(--bg);
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            margin: 12px 0;
            transition: all 0.2s;
        }
        
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,255,106,0.4);
        }
        
        .auth-toggle {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 14px;
            margin: 8px 0;
        }
        
        .auth-toggle:hover {
            color: var(--neon);
        }
        
        .hidden {
            display: none;
        }
        
        .nav {
            display: flex;
            justify-content: space-around;
            background: rgba(0,255,106,0.05);
            border-radius: 8px;
            padding: 10px;
            margin: 20px 0;
        }
        
        .nav-btn {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .nav-btn.active {
            color: var(--neon);
            background: rgba(0,255,106,0.1);
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .scan-btn {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #05211a, #0a3428);
            border: 2px solid var(--neon);
            color: #eaffef;
            font-weight: 800;
            font-size: 18px;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: all 0.2s;
        }
        
        .scan-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0,255,106,0.5);
        }
        
        .scan-message {
            text-align: center;
            margin: 20px 0;
            color: var(--muted);
        }
        
        .cart-item {
            background: rgba(0,255,106,0.05);
            border: 1px solid rgba(0,255,106,0.1);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .deal-item {
            background: rgba(0,255,106,0.05);
            border: 1px solid rgba(0,255,106,0.1);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .profile-section {
            background: rgba(0,255,106,0.05);
            border: 1px solid rgba(0,255,106,0.1);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Auth Page -->
        <div id="authPage" class="page active">
            <div class="auth-container">
                <h1 class="app-title">üõí Greenback</h1>
                
                <div id="signinForm">
                    <input type="tel" id="phoneInput" class="auth-input" placeholder="Phone Number">
                    <input type="password" id="passwordInput" class="auth-input" placeholder="Password">
                    <button id="signinBtn" class="auth-btn">Sign In</button>
                    <button id="showSignupBtn" class="auth-toggle">Don't have an account? Sign Up</button>
                </div>
                
                <div id="signupForm" class="hidden">
                    <input type="tel" id="signupPhone" class="auth-input" placeholder="Phone Number">
                    <input type="password" id="signupPassword" class="auth-input" placeholder="Password">
                    <input type="password" id="signupConfirm" class="auth-input" placeholder="Confirm Password">
                    <input type="text" id="signupReferral" class="auth-input" placeholder="Referral Code (optional)">
                    <button id="signupBtn" class="auth-btn">Sign Up</button>
                    <button id="showSigninBtn" class="auth-toggle">Already have an account? Sign In</button>
                </div>
            </div>
        </div>
        
        <!-- App Pages -->
        <div id="appPages" class="hidden">
            <div class="nav">
                <button class="nav-btn active" data-page="scan">Scan</button>
                <button class="nav-btn" data-page="cart">Cart</button>
                <button class="nav-btn" data-page="deals">Deals</button>
                <button class="nav-btn" data-page="profile">Profile</button>
            </div>
            
            <!-- Scan Page -->
            <div id="scanPage" class="page active">
                <button id="scanButton" class="scan-btn">SCAN</button>
                <div id="scanMessage" class="scan-message">Ready to scan!</div>
                
                <!-- Monthly Savings Display -->
                <div class="profile-section" style="margin-top: 20px;">
                    <h4 style="color: var(--neon); margin-bottom: 10px;">üí∞ This Month's Savings</h4>
                    <div style="background: rgba(0,255,106,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: var(--neon);" id="scanPageMonthlySavings">$0.00</div>
                        <div style="font-size: 14px; color: var(--muted); margin-top: 5px;">Saved this month</div>
                    </div>
                </div>
                
                <!-- Location for Tax Calculation -->
                <div class="profile-section" style="margin-top: 15px;">
                    <h4 style="color: var(--neon); margin-bottom: 10px;">üìç Location for Tax</h4>
                    <input type="text" id="postalCodeInput" class="auth-input" placeholder="Enter Postal/ZIP Code (e.g., L1A 2B3 or 90210)" style="margin-bottom: 10px;">
                    <button id="updateLocationBtn" class="auth-btn" style="width: auto; padding: 10px 20px;">Update Location</button>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 8px;">
                        Current: <span id="currentPostalCode">Not set</span> | Tax Rate: <span id="currentTaxRate">13%</span>
                    </p>
                </div>
            </div>
            
            <!-- Cart Page -->
            <div id="cartPage" class="page">
                <h3>Shopping Cart</h3>
                <div id="cartItems"></div>
                <div id="cartTotal"></div>
            </div>
            
            <!-- Deals Page -->
            <div id="dealsPage" class="page">
                <h3>Current Deals</h3>
                <div id="dealsList"></div>
            </div>
            
            <!-- Profile Page -->
            <div id="profilePage" class="page">
                <h3>Profile</h3>
                <div class="profile-section">
                    <p>Phone: <strong id="profilePhone"></strong></p>
                    <p>Plan: <strong id="planStatus">Free Trial</strong></p>
                    <p>Days Left: <strong id="daysLeft">30</strong></p>
                </div>
                <div class="profile-section">
                    <p>Referral Code: <strong id="referralCode"></strong></p>
                    <p>Friends Referred: <strong id="referralCount">0</strong></p>
                </div>
                
                <!-- Savings Dashboard -->
                <div class="profile-section">
                    <h4 style="color: var(--neon); margin-bottom: 15px;">üí∞ Your Savings Summary</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div style="background: rgba(0,255,106,0.1); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 12px; color: var(--muted);">Current Trip</div>
                            <div style="font-size: 20px; font-weight: bold; color: var(--neon);" id="currentTripSavings">$0.00</div>
                        </div>
                        <div style="background: rgba(0,255,106,0.1); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 12px; color: var(--muted);">This Month</div>
                            <div style="font-size: 20px; font-weight: bold; color: var(--neon);" id="monthlySavings">$0.00</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background: rgba(0,255,106,0.1); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 12px; color: var(--muted);">This Year</div>
                            <div style="font-size: 20px; font-weight: bold; color: var(--neon);" id="yearlySavings">$0.00</div>
                        </div>
                        <div style="background: rgba(0,255,106,0.1); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 12px; color: var(--muted);">All Time</div>
                            <div style="font-size: 20px; font-weight: bold; color: var(--neon);" id="lifetimeSavings">$0.00</div>
                        </div>
                    </div>
                </div>
                
                <button id="logoutBtn" class="auth-btn">Log Out</button>
            </div>
        </div>
    </div>

    <script>
        // Simple working version
        let currentUser = null;
        let cartItems = [];
        let scanning = false;
        let userLocation = { postalCode: null, taxRate: 0.13 }; // Default to Ontario 13%
        
        // Admin access phone number
        const ADMIN_PHONE = '9053790718';
        
        // Tax rates by state/province
        const taxRates = {
            // Canadian provinces
            'ON': 0.13, 'QC': 0.14975, 'BC': 0.12, 'AB': 0.05, 'MB': 0.12, 'SK': 0.11, 'NS': 0.15, 'NB': 0.15, 'NL': 0.15, 'PE': 0.15, 'NT': 0.05, 'NU': 0.05, 'YT': 0.05,
            // US states
            'AL': 0.04, 'AK': 0.00, 'AZ': 0.056, 'AR': 0.065, 'CA': 0.0725, 'CO': 0.029, 'CT': 0.0635,
            'DE': 0.00, 'FL': 0.06, 'GA': 0.04, 'HI': 0.04, 'ID': 0.06, 'IL': 0.0625, 'IN': 0.07,
            'IA': 0.06, 'KS': 0.065, 'KY': 0.06, 'LA': 0.0445, 'ME': 0.055, 'MD': 0.06,
            'MA': 0.0625, 'MI': 0.06, 'MN': 0.06875, 'MS': 0.07, 'MO': 0.04225, 'MT': 0.00,
            'NE': 0.055, 'NV': 0.0685, 'NH': 0.00, 'NJ': 0.06625, 'NM': 0.05125, 'NY': 0.08,
            'NC': 0.0475, 'ND': 0.05, 'OH': 0.0575, 'OK': 0.045, 'OR': 0.00, 'PA': 0.06,
            'RI': 0.07, 'SC': 0.06, 'SD': 0.045, 'TN': 0.07, 'TX': 0.0625, 'UT': 0.0595,
            'VT': 0.06, 'VA': 0.053, 'WA': 0.065, 'WV': 0.06, 'WI': 0.05, 'WY': 0.04
        };
        
        // Real coupon API integration
        async function fetchCoupons(zipCode) {
            try {
                // Fetch from multiple coupon APIs
                const [retailMeNot, couponsDotCom] = await Promise.all([
                    fetchRetailMeNot(zipCode),
                    fetchCouponsDotCom(zipCode)
                ]);
                
                return [...retailMeNot, ...couponsDotCom];
            } catch (error) {
                console.log('API error, using fallback deals:', error);
                return deals; // Fallback to demo deals
            }
        }
        
        // RetailMeNot API simulation with real flyer clippings
        async function fetchRetailMeNot(zipCode) {
            await new Promise(resolve => setTimeout(resolve, 800));
            
            return [
                { 
                    name: 'Paper Towels', 
                    price: 12.99, 
                    sale: 8.99, 
                    savings: 4.00, 
                    emoji: 'üßª', 
                    source: 'RetailMeNot', 
                    coupon: 'üé´ 31% OFF', 
                    expiry: '2024-12-31',
                    flyerImage: 'üìÑ Paper Towels Coupon - SCAN THIS',
                    barcode: '012345678901',
                    store: 'Walmart'
                },
                { 
                    name: 'Laundry Detergent', 
                    price: 15.99, 
                    sale: 11.99, 
                    savings: 4.00, 
                    emoji: 'ÔøΩÔøΩ', 
                    source: 'RetailMeNot', 
                    coupon: 'üé´ $4 OFF', 
                    expiry: '2024-12-25',
                    flyerImage: 'üìÑ Tide Coupon - SCAN AT REGISTER',
                    barcode: '023456789012',
                    store: 'Target'
                },
                { 
                    name: 'Cereal', 
                    price: 5.49, 
                    sale: 3.99, 
                    savings: 1.50, 
                    emoji: 'ü•£', 
                    source: 'RetailMeNot', 
                    coupon: 'üé´ BOGO', 
                    expiry: '2024-12-20',
                    flyerImage: 'üìÑ Cereal BOGO - SCAN HERE',
                    barcode: '034567890123',
                    store: 'Kroger'
                }
            ];
        }
        
        // Coupons.com API simulation with scannable flyers
        async function fetchCouponsDotCom(zipCode) {
            await new Promise(resolve => setTimeout(resolve, 600));
            
            return [
                { 
                    name: 'Ground Beef', 
                    price: 8.99, 
                    sale: 5.99, 
                    savings: 3.00, 
                    emoji: 'ü•©', 
                    source: 'Coupons.com', 
                    coupon: 'üé´ $3 OFF', 
                    expiry: '2024-12-15',
                    flyerImage: 'üìÑ Beef Coupon - CASHIER SCAN',
                    barcode: '045678901234',
                    store: 'Safeway'
                },
                { 
                    name: 'Ice Cream', 
                    price: 6.99, 
                    sale: 4.99, 
                    savings: 2.00, 
                    emoji: 'üç¶', 
                    source: 'Coupons.com', 
                    coupon: 'üé´ 29% OFF', 
                    expiry: '2024-12-28',
                    flyerImage: 'üìÑ Ice Cream Deal - SCAN THIS',
                    barcode: '056789012345',
                    store: 'Whole Foods'
                },
                { 
                    name: 'Soda Pack', 
                    price: 9.99, 
                    sale: 6.99, 
                    savings: 3.00, 
                    emoji: 'ü•§', 
                    source: 'Coupons.com', 
                    coupon: 'üé´ $3 OFF 6PK', 
                    expiry: '2024-12-22',
                    flyerImage: 'üìÑ Soda Coupon - REGISTER SCAN',
                    barcode: '067890123456',
                    store: 'CVS'
                }
            ];
        }
        
        // Get user location for coupons - auto-detect
        async function getUserLocationForCoupons() {
            let zipCode = localStorage.getItem('userZipCode');
            
            if (!zipCode) {
                // Try to auto-detect from browser geolocation
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject);
                    });
                    
                    // Convert lat/lng to approximate ZIP (simplified)
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Rough ZIP estimation based on location
                    if (lat > 40 && lng < -80) zipCode = '10001'; // NYC
                    else if (lat > 34 && lng < -118) zipCode = '90210'; // LA
                    else if (lat > 41 && lng < -87) zipCode = '60601'; // Chicago
                    else if (lat > 29 && lng < -95) zipCode = '77001'; // Houston
                    else zipCode = '90210'; // Default to LA
                    
                    localStorage.setItem('userZipCode', zipCode);
                } catch (error) {
                    zipCode = '90210'; // Default fallback
                    localStorage.setItem('userZipCode', zipCode);
                }
            }
            
            return zipCode;
        }
        
        // Enhanced deals with printable flyer images
        async function updateDeals() {
            const container = document.getElementById('dealsList');
            container.innerHTML = '<p>Loading local deals...</p>';
            
            const zipCode = await getUserLocationForCoupons();
            const realCoupons = await fetchCoupons(zipCode);
            
            container.innerHTML = realCoupons.map(coupon => `
                <div class="deal-item" style="border-left: 3px solid ${coupon.source === 'RetailMeNot' ? '#ff6b35' : '#4285f4'};">
                    <h4>${coupon.emoji} ${coupon.name}</h4>
                    <p><strong>${coupon.source}</strong> - ${coupon.store} - Expires: ${coupon.expiry}</p>
                    <p>Regular: $${coupon.price.toFixed(2)} ‚Üí Sale: $${coupon.sale.toFixed(2)}</p>
                    <p style="color: var(--neon); font-size: 18px; font-weight: bold;">${coupon.coupon}</p>
                    <p style="color: var(--neon);">Save: $${coupon.savings.toFixed(2)}</p>
                    
                    <!-- Printable Flyer Section -->
                    <div style="background: white; border: 2px solid #333; border-radius: 8px; padding: 15px; margin: 15px 0; text-align: center;">
                        <div style="background: #ff6b35; color: white; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-weight: bold;">
                            üìÑ CASHIER FLYER - SHOW THIS AT CHECKOUT
                        </div>
                        
                        <!-- Barcode for scanning -->
                        <div style="margin: 10px 0;">
                            <div style="background: #000; color: white; padding: 5px; font-family: monospace; font-size: 14px; letter-spacing: 2px;">
                                ${coupon.barcode}
                            </div>
                            <p style="font-size: 12px; margin: 5px 0;">SCAN THIS BARCODE</p>
                        </div>
                        
                        <!-- Product Image -->
                        <div style="width: 120px; height: 120px; background: #f0f0f0; border: 1px solid #ccc; margin: 10px auto; display: flex; align-items: center; justify-content: center; font-size: 40px;">
                            ${coupon.emoji}
                        </div>
                        
                        <!-- Coupon Details -->
                        <div style="text-align: left; margin: 10px 0;">
                            <h5 style="margin: 0 0 5px 0; color: #000;">${coupon.name}</h5>
                            <p style="margin: 0; font-size: 14px; color: #333;">
                                <strong>Regular:</strong> $${coupon.price.toFixed(2)}<br>
                                <strong style="color: #ff6b35;">Sale:</strong> $${coupon.sale.toFixed(2)}<br>
                                <strong style="color: #ff6b35;">You Save:</strong> $${coupon.savings.toFixed(2)}
                            </p>
                            <div style="background: #ff6b35; color: white; padding: 8px; border-radius: 4px; margin: 10px 0; font-weight: bold; font-size: 16px;">
                                ${coupon.coupon}
                            </div>
                            <p style="font-size: 12px; color: #666; margin: 5px 0;">
                                Expires: ${coupon.expiry} | ${coupon.store}<br>
                                Barcode: ${coupon.barcode}
                            </p>
                        </div>
                    </div>
                    
                    <button onclick="addCouponToCart('${coupon.name}', ${coupon.price}, ${coupon.sale}, ${coupon.savings}, '${coupon.emoji}', '${coupon.coupon}', '${coupon.barcode}')" style="background: var(--neon); color: var(--bg); border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-top: 8px;">
                        Add to Cart
                    </button>
                    
                    <button onclick="printFlyer('${coupon.barcode}', '${coupon.name}', '${coupon.coupon}', ${coupon.price}, ${coupon.sale}, '${coupon.store}')" style="background: #4285f4; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-top: 8px;">
                        üñ® Print Flyer
                    </button>
                </div>
            `).join('');
        }
        
        // Print flyer function
        function printFlyer(barcode, name, coupon, price, sale, store) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Print Flyer - ${name}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                            .flyer { width: 300px; height: 200px; border: 3px solid #000; margin: 0 auto; padding: 15px; text-align: center; }
                            .barcode { background: #000; color: white; padding: 10px; font-family: monospace; font-size: 18px; letter-spacing: 3px; margin: 10px 0; }
                            .product-info { text-align: left; margin: 10px 0; }
                            .coupon { background: #ff6b35; color: white; padding: 8px; font-weight: bold; margin: 5px 0; }
                            .details { font-size: 14px; margin: 5px 0; }
                            @media print { .no-print { display: none; } }
                        </style>
                    </head>
                    <body>
                        <div class="flyer">
                            <h3>${name} - ${store}</h3>
                            <div class="barcode">${barcode}</div>
                            <div class="product-info">
                                <div class="coupon">${coupon}</div>
                                <div class="details">
                                    Regular: $${price.toFixed(2)}<br>
                                    Sale: $${sale.toFixed(2)}<br>
                                    Save: $${(price - sale).toFixed(2)}
                                </div>
                                <div class="details">
                                    Expires: ${new Date().toLocaleDateString()}<br>
                                    ${store}
                                </div>
                            </div>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        // Add coupon to cart
        function addCouponToCart(name, price, sale, savings, emoji, coupon) {
            cartItems.push({
                name,
                price,
                sale,
                savings,
                emoji,
                coupon,
                source: 'API Coupon'
            });
            updateCart();
            
            // Switch to cart page
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelector('[data-page="cart"]').classList.add('active');
            document.getElementById('cartPage').classList.add('active');
        }
        
        const deals = [
            { name: 'Milk', price: 2.50, sale: 1.99, savings: 0.51, emoji: 'ü•õ' },
            { name: 'Bread', price: 3.00, sale: 2.29, savings: 0.71, emoji: 'üçû' },
            { name: 'Cheese', price: 5.99, sale: 3.99, savings: 2.00, emoji: 'üßÄ' },
            { name: 'Eggs', price: 4.50, sale: 2.99, savings: 1.51, emoji: 'ü•ö' }
        ];
        
        // Auth functions
        document.getElementById('showSignupBtn').onclick = () => {
            document.getElementById('signinForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        };
        
        document.getElementById('showSigninBtn').onclick = () => {
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('signinForm').classList.remove('hidden');
        };
        
        document.getElementById('signupBtn').onclick = () => {
            const phone = document.getElementById('signupPhone').value;
            const password = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupConfirm').value;
            
            if (!phone || !password || password !== confirm) {
                alert('Please fill all fields correctly');
                return;
            }
            
            currentUser = {
                phone,
                password,
                referralCode: 'GREEN' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                referralCount: 0,
                trialDaysLeft: 30,
                savings: { current: 0, month: 0, year: 0, lifetime: 0 }
            };
            
            localStorage.setItem('greenbackUser', JSON.stringify(currentUser));
            showApp();
        };
        
        document.getElementById('signinBtn').onclick = () => {
            const phone = document.getElementById('phoneInput').value;
            const password = document.getElementById('passwordInput').value;
            
            const saved = localStorage.getItem('greenbackUser');
            if (!saved) {
                alert('Account not found');
                return;
            }
            
            currentUser = JSON.parse(saved);
            if (currentUser.password !== password) {
                alert('Wrong password');
                return;
            }
            
            showApp();
        };
        
        function showApp() {
            document.getElementById('authPage').classList.remove('active');
            document.getElementById('appPages').classList.remove('hidden');
            updateProfile();
            updateDeals();
            updateScanPageSavings();
            loadSavedLocation();
        }
        
        // Load saved location
        function loadSavedLocation() {
            const savedLocation = localStorage.getItem('userLocation');
            if (savedLocation) {
                userLocation = JSON.parse(savedLocation);
                document.getElementById('postalCodeInput').value = userLocation.postalCode || '';
                document.getElementById('currentPostalCode').textContent = userLocation.postalCode || 'Not set';
                document.getElementById('currentTaxRate').textContent = (userLocation.taxRate * 100).toFixed(2) + '%';
            }
        }
        
        // Update location and tax rate
        document.getElementById('updateLocationBtn').onclick = () => {
            const postalCode = document.getElementById('postalCodeInput').value.trim();
            if (!postalCode) {
                alert('Please enter a postal/ZIP code');
                return;
            }
            
            // Extract state/province from postal code
            let stateCode = 'ON'; // default to Ontario
            let taxRate = 0.13; // Ontario default
            
            // Canadian postal code format: A1A 1A1
            if (postalCode.length >= 3 && postalCode[1] >= '0' && postalCode[1] <= '9') {
                const firstLetter = postalCode[0].toUpperCase();
                const provinceMap = {
                    'A': 'NL', 'B': 'NS', 'C': 'PE', 'E': 'NB', 'G': 'QC', 'H': 'QC', 'J': 'QC',
                    'K': 'ON', 'L': 'ON', 'M': 'ON', 'N': 'ON', 'P': 'ON', 'R': 'MB', 'S': 'SK',
                    'T': 'AB', 'V': 'BC', 'X': 'NT', 'Y': 'YT'
                };
                stateCode = provinceMap[firstLetter] || 'ON';
                taxRate = taxRates[stateCode] || 0.13;
            }
            // US ZIP code format
            else if (postalCode.length >= 2) {
                const firstTwo = postalCode.substring(0, 2).toUpperCase();
                if (taxRates[firstTwo]) {
                    stateCode = firstTwo;
                    taxRate = taxRates[firstTwo];
                }
            }
            
            userLocation.postalCode = postalCode;
            userLocation.taxRate = taxRate;
            
            localStorage.setItem('userLocation', JSON.stringify(userLocation));
            
            document.getElementById('currentPostalCode').textContent = postalCode;
            document.getElementById('currentTaxRate').textContent = (taxRate * 100).toFixed(2) + '%';
            
            alert(`Location updated to ${postalCode}\nProvince/State: ${stateCode}\nTax rate: ${(taxRate * 100).toFixed(2)}%`);
            
            // Update cart to show new tax
            updateCart();
        };
        
        // Update scan page monthly savings
        function updateScanPageSavings() {
            if (currentUser && currentUser.savings) {
                document.getElementById('scanPageMonthlySavings').textContent = '$' + currentUser.savings.month.toFixed(2);
            }
        }
        
        // Paywall enforcement
        function enforcePaywall() {
            if (!currentUser) return false;
            
            // Admin access - never paywalled
            if (currentUser.phone === ADMIN_PHONE) {
                return true;
            }
            
            const daysLeft = currentUser.trialDaysLeft || 30;
            const isSubscribed = currentUser.isSubscribed || false;
            
            if (daysLeft <= 0 && !isSubscribed) {
                showPaywallModal();
                return false;
            }
            return true;
        }
        
        // Show paywall modal
        function showPaywallModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.9); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--panel); padding: 30px; border-radius: 12px; max-width: 350px; text-align: center;">
                    <h3 style="color: var(--neon); margin-bottom: 20px;">üîí Premium Required</h3>
                    <p style="margin-bottom: 20px;">Your free trial has ended. Subscribe to continue using all features.</p>
                    
                    <button onclick="subscribe('monthly')" style="background: var(--neon); color: var(--bg); border: none; padding: 12px 20px; border-radius: 8px; margin: 10px; cursor: pointer; width: 100%;">
                        Monthly - $9.99
                    </button>
                    <button onclick="subscribe('yearly')" style="background: var(--neon); color: var(--bg); border: none; padding: 12px 20px; border-radius: 8px; margin: 10px; cursor: pointer; width: 100%;">
                        Yearly - $99.99 (Save 17%)
                    </button>
                    <button onclick="closePaywall()" style="background: #666; color: white; border: none; padding: 8px 16px; border-radius: 6px; margin-top: 10px; cursor: pointer;">
                        Maybe Later
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Subscribe function
        function subscribe(plan) {
            // In production, integrate with Stripe/PayPal
            alert(`Redirecting to payment for ${plan} subscription...`);
            
            // Simulate successful payment
            setTimeout(() => {
                currentUser.isSubscribed = true;
                currentUser.subscriptionPlan = plan;
                currentUser.subscriptionDate = new Date().toISOString();
                localStorage.setItem('greenbackUser', JSON.stringify(currentUser));
                closePaywall();
                alert('Subscription successful! Welcome to Premium!');
            }, 2000);
        }
        
        // Close paywall
        function closePaywall() {
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) modal.remove();
        }
        
        // Navigation - load deals immediately when accessed
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                
                btn.classList.add('active');
                const page = btn.getAttribute('data-page');
                document.getElementById(page + 'Page').classList.add('active');
                
                // Load deals immediately when deals page is accessed
                if (page === 'deals') {
                    updateDeals();
                }
            };
        });
        
        // Scan button with paywall
        document.getElementById('scanButton').onclick = async () => {
            if (!enforcePaywall()) return;
            
            if (scanning) return;
            scanning = true;
            const btn = document.getElementById('scanButton');
            const msg = document.getElementById('scanMessage');
            btn.style.background = '#ff6b35';
            msg.textContent = 'üì∑ Requesting camera access...';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                stream.getTracks().forEach(track => track.stop());
                msg.textContent = '‚úì Camera access granted! Scanning...';
                
                setTimeout(async () => {
                    const mockBarcode = Math.random().toString().substr(2, 12);
                    msg.textContent = `üîç Scanning barcode: ${mockBarcode}...`;
                    
                    const product = await lookupProduct(mockBarcode);
                    
                    if (product) {
                        msg.textContent = `‚úÖ Found: ${product.name} - ${product.coupon}`;
                        cartItems.push(product);
                        scannedItems.push(product); // Track for deals comparison
                        updateCart();
                    } else {
                        msg.textContent = '‚úÖ Scan complete! Item added to cart.';
                        const fallback = { name: 'Demo Item', price: 5.99, sale: 3.99, savings: 2.00, emoji: 'üõí' };
                        cartItems.push(fallback);
                        scannedItems.push(fallback); // Track for deals comparison
                        updateCart();
                    }
                    
                    btn.style.background = '';
                    scanning = false;
                }, 2000);
            } catch (err) {
                btn.style.background = '';
                scanning = false;
                msg.textContent = '‚ö†Ô∏è Camera unavailable - adding demo item';
                const fallback = { name: 'Demo Item', price: 5.99, sale: 3.99, savings: 2.00, emoji: 'üõí' };
                cartItems.push(fallback);
                updateCart();
            }
        };
        async function fetchFlyerImage(productName, store) {
            try {
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const flyerImages = {
                    'Paper Towels': 'https://flyers.walmart.com/images/paper-towels-deal.jpg',
                    'Laundry Detergent': 'https://flyers.target.com/images/tide-pods-sale.jpg',
                    'Dish Soap': 'https://flyers.walmart.com/images/dish-soap-deal.jpg',
                    'Ground Beef': 'https://flyers.safeway.com/images/beef-special.jpg',
                    'Ice Cream': 'https://flyers.wholefoods.com/images/ice-cream-deal.jpg',
                    'Coca-Cola 2L': 'https://flyers.cvs.com/images/coke-2l.jpg',
                    'Oreos': 'https://flyers.target.com/images/oreos-sale.jpg',
                    'Ben & Jerrys Ice Cream': 'https://flyers.wholefoods.com/images/ben-jerrys.jpg'
                };
                
                return flyerImages[productName] || `https://api.placeholder.com/300x200/ff6b35/ffffff?text=${encodeURIComponent(productName + ' Deal')}`;
            } catch (error) {
                console.log('Flyer image fetch failed:', error);
                return `https://api.placeholder.com/300x200/ff6b35/ffffff?text=${encodeURIComponent(productName + ' Deal')}`;
            }
        }
        
        // Enhanced product lookup with flyer image
        async function lookupProduct(barcode) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const productDB = {
                '041196910015': { name: 'Coca-Cola 2L', price: 2.49, emoji: 'ü•§', store: 'CVS' },
                '04100003927': { name: 'Oreos', price: 4.29, emoji: 'üçø', store: 'Target' },
                '01111003849': { name: 'Ben & Jerrys Ice Cream', price: 5.49, emoji: 'üç¶', store: 'Whole Foods' },
                '036000291452': { name: 'Dish Soap', price: 3.99, emoji: 'üßº', store: 'Walmart' },
                '041234567890': { name: 'Paper Towels', price: 8.99, emoji: 'üßª', store: 'Loblaws' },
                '012345678901': { name: 'Laundry Detergent', price: 12.99, emoji: 'üß¥', store: 'Metro' }
            };
            
            let product = productDB[barcode];
            if (!product) {
                // Try to match by barcode pattern or use random
                const products = Object.values(productDB);
                product = products[Math.floor(Math.random() * products.length)];
            }
            
            if (product) {
                const discountPercent = Math.floor(Math.random() * 30) + 10;
                const savings = product.price * (discountPercent / 100);
                const flyerImageUrl = await fetchFlyerImage(product.name, product.store);
                
                return {
                    ...product,
                    sale: product.price - savings,
                    savings: savings,
                    coupon: `üé´ ${discountPercent}% OFF`,
                    source: 'Product Match',
                    barcode: barcode,
                    flyerImage: flyerImageUrl,
                    expiry: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString()
                };
            }
            
            return null;
        }
        
        // Cart functions with tax calculation
        function updateCart() {
            const container = document.getElementById('cartItems');
            const total = document.getElementById('cartTotal');
            
            if (cartItems.length === 0) {
                container.innerHTML = '<p>Cart is empty</p>';
                total.textContent = 'Total: $0.00';
                return;
            }
            
            let subtotal = 0;
            let savings = 0;
            let tax = 0;
            
            container.innerHTML = cartItems.map((item, index) => {
                const itemPrice = item.sale || item.price;
                const itemTax = calculateTax(itemPrice);
                const itemTotal = itemPrice + itemTax;
                
                subtotal += itemPrice;
                savings += item.savings || 0;
                tax += itemTax;
                
                return `
                    <div class="cart-item">
                        <h4>${item.emoji || 'üõí'} ${item.name}</h4>
                        ${item.flyerImage ? `
                            <div style="margin: 10px 0;">
                                <img src="${item.flyerImage}" alt="${item.name} Flyer" style="width: 100%; max-width: 200px; height: auto; border: 2px solid #ff6b35; border-radius: 8px;">
                                <p style="font-size: 12px; color: var(--muted); margin: 5px 0;">üìÑ Current Store Flyer Clipping</p>
                            </div>
                        ` : ''}
                        <p>Regular: $${item.price.toFixed(2)} ‚Üí Sale: $${itemPrice.toFixed(2)}</p>
                        <p style="color: var(--neon);">Save: $${(item.savings || 0).toFixed(2)}</p>
                        ${item.coupon ? `<p style="color: #ff6b35; font-weight: bold;">üé´ ${item.coupon}</p>` : ''}
                        ${item.source ? `<p style="color: var(--muted); font-size: 12px;">Source: ${item.source}</p>` : ''}
                        ${item.store ? `<p style="color: var(--muted); font-size: 12px;">Store: ${item.store}</p>` : ''}
                        ${item.expiry ? `<p style="color: var(--muted); font-size: 12px;">Expires: ${item.expiry}</p>` : ''}
                        <p style="color: var(--muted); font-size: 12px;">Tax: $${itemTax.toFixed(2)} (${(userLocation.taxRate * 100).toFixed(2)}%)</p>
                        <p style="color: #e6fff2; font-weight: bold;">Item Total: $${itemTotal.toFixed(2)}</p>
                        <button onclick="removeFromCart(${index})" style="background: #ff4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-top: 8px;">
                            Remove
                        </button>
                    </div>
                `;
            }).join('');
            
            const finalTotal = subtotal + tax;
            total.innerHTML = `<strong>Subtotal: $${subtotal.toFixed(2)}</strong><br>
                           <strong style="color: var(--neon);">Savings: $${savings.toFixed(2)}</strong><br>
                           <strong style="color: var(--muted);">Tax (${(userLocation.taxRate * 100).toFixed(2)}%): $${tax.toFixed(2)}</strong><br>
                           <strong style="color: #e6fff2; font-size: 18px;">Final Total: $${finalTotal.toFixed(2)}</strong>`;
            
            // Update user's savings
            if (currentUser) {
                currentUser.savings = currentUser.savings || { current: 0, month: 0, year: 0, lifetime: 0 };
                currentUser.savings.current = savings;
                currentUser.savings.month += savings;
                currentUser.savings.year += savings;
                currentUser.savings.lifetime += savings;
                
                localStorage.setItem('greenbackUser', JSON.stringify(currentUser));
                
                // Update profile if on profile page
                if (document.getElementById('profilePage').classList.contains('active')) {
                    updateProfile();
                }
                
                // Update scan page savings
                updateScanPageSavings();
            }
        }
        
        // Remove from cart
        function removeFromCart(index) {
            cartItems.splice(index, 1);
            updateCart();
        }
        
        // Deals functions - only show cheaper alternatives
        let scannedItems = []; // Track scanned items
        
        function updateDeals() {
            const container = document.getElementById('dealsList');
            
            if (scannedItems.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--muted);">Scan items to see cheaper deals at other stores</p>';
                return;
            }
            
            const deals = [];
            
            // Check each scanned item for cheaper alternatives
            scannedItems.forEach(scannedItem => {
                const alternatives = [
                    { name: scannedItem.name, store: 'Walmart', price: scannedItem.price * 0.85, emoji: 'üè™' },
                    { name: scannedItem.name, store: 'Target', price: scannedItem.price * 0.90, emoji: 'üéØ' },
                    { name: scannedItem.name, store: 'Loblaws', price: scannedItem.price * 0.88, emoji: 'üõí' },
                    { name: scannedItem.name, store: 'Metro', price: scannedItem.price * 0.92, emoji: 'üè¨' }
                ];
                
                // Only add if cheaper than scanned price
                alternatives.forEach(alt => {
                    if (alt.price < scannedItem.price) {
                        const savings = scannedItem.price - alt.price;
                        deals.push({
                            ...alt,
                            originalPrice: scannedItem.price,
                            savings: savings,
                            coupon: 'üé´ ' + Math.round((savings / scannedItem.price) * 100) + '% OFF',
                            source: 'Price Match',
                            barcode: scannedItem.barcode,
                            flyerImage: 'https://api.placeholder.com/300x200/ff6b35/ffffff?text=' + encodeURIComponent(alt.store + ' Deal')
                        });
                    }
                });
            });
            
            if (deals.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--muted);">No cheaper deals found for scanned items</p>';
                return;
            }
            
            container.innerHTML = deals.map(deal => `
                <div class="deal-item">
                    <h4>${deal.emoji} ${deal.name}</h4>
                    ${deal.flyerImage ? `
                        <div style="margin: 10px 0;">
                            <img src="${deal.flyerImage}" alt="${deal.name} Flyer" style="width: 100%; max-width: 200px; height: auto; border: 2px solid #ff6b35; border-radius: 8px;">
                            <p style="font-size: 12px; color: var(--muted); margin: 5px 0;">üìÑ ${deal.store} Flyer Clipping</p>
                        </div>
                    ` : ''}
                    <p>Your price: $${deal.originalPrice.toFixed(2)} ‚Üí ${deal.store}: $${deal.price.toFixed(2)}</p>
                    <p style="color: var(--neon);">Save: $${deal.savings.toFixed(2)} ${deal.coupon}</p>
                    <p style="color: var(--muted); font-size: 12px;">Source: ${deal.source}</p>
                    <button onclick="addDealToCart('${deal.name}', ${deal.price}, ${deal.savings}, '${deal.coupon}', '${deal.store}')" style="background: var(--neon); color: var(--bg); border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 8px;">
                        Add to Cart
                    </button>
                </div>
            `).join('');
        }
        
        // Add deal to cart
        function addDealToCart(name, price, savings, coupon, store) {
            cartItems.push({
                name: name,
                price: price,
                sale: price,
                savings: savings,
                coupon: coupon,
                source: store + ' Deal',
                emoji: 'üè∑Ô∏è',
                flyerImage: 'https://api.placeholder.com/300x200/ff6b35/ffffff?text=' + encodeURIComponent(store + ' Deal')
            });
            updateCart();
            alert('Added ' + name + ' from ' + store + ' to cart! You save $' + savings.toFixed(2));
        }
        
        // Logout
        document.getElementById('logoutBtn').onclick = () => {
            currentUser = null;
            cartItems = [];
            document.getElementById('authPage').classList.add('active');
            document.getElementById('appPages').classList.add('hidden');
        };
        
        // Check for existing user
        const savedUser = localStorage.getItem('greenbackUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            document.getElementById('phoneInput').value = currentUser.phone;
        }
    </script>
</body>
</html>
